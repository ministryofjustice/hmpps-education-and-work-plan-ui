{% extends "../../partials/layout.njk" %}

{% set pageId = "create-goals" %}
{% set pageTitle = "Create goals with prisoner" %}

{% block beforeContent %}
  {% include "../../partials/breadcrumb.njk" %}
{% endblock %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">

      <h1 class="govuk-heading-l">Create goals with {{ prisonerSummary.firstName | safe }} {{ prisonerSummary.lastName | safe }}</h1>

      <h2 class="govuk-heading-s">Add goals</h2>
      <p class="govuk-hint">
        Goals should be SMART, meaning 'specific', 'measurable', 'achievable', 'relevant' and 'time-bound'. SMART goals allow progress to be better measured and evaluated.<br>
        You can add the steps to achieve the goal on the next page.
      </p>

      <form class="form" method="post" novalidate="" action="create">
        <input type="hidden" name="_csrf" value="{{ csrfToken }}" />

        {% for goals in formValues.goals or range(1) %}
        {% set goalLoop = loop %}
        <div class="govuk-summary-card">
          <div class="govuk-summary-card__title-wrapper">
            <h2 class="govuk-summary-card__title">
              Goal {{ goalLoop.index }}
            </h2>
            <ul class="govuk-summary-card__actions govuk-!-display-none-print govuk-!-margin-0">
              <li class="govuk-summary-card__action">
                {% if goalLoop.length > 1 %}
                  {{ govukButton({
                    name: "action",
                    value: "remove-goal|" + goalLoop.index0,
                    text: "Remove goal",
                    classes: "govuk-button--secondary govuk-!-margin-bottom-0",
                    attributes: {
                      'data-qa': 'remove-goal-button',
                      formaction: 'create/REMOVE_GOAL?goalNumber=' + goalLoop.index0
                    }
                  }) }}
                {% endif %}
              </li>
            </ul>
          </div>

          <div class="govuk-summary-card__content">

            {{ govukCharacterCount({
              name: "goals[" + goalLoop.index0 + "][title]",
              id: "goals-" + goalLoop.index0 + "-title",
              value: formValues.goals[(goalLoop.index0)].title,
              maxlength: 512,
              label: {
                text: "Describe the goal",
                classes: "govuk-label--s"
              },
              charactersOverLimitText: {
                one: 'Goal must be 512 characters or less',
                other: 'Goal must be 512 characters or less'
              },
              errorMessage: validationErrors | findError("goals-" + goalLoop.index0 + "-title")
            }) }}

            {% set anotherDateHtml %}
              {{ govukDateInput({
                id: "goals-" + goalLoop.index0 + "-anotherDate",
                fieldset: {
                  legend: {
                    text: "When are they aiming to achieve this goal by?",
                    classes: "govuk-visually-hidden"
                  }
                },
                hint: {
                  text: "For example, 27 3 2007"
                },
                items: [
                  {
                    id: 'goals-' + goalLoop.index0 + '-anotherDate-day',
                    label: 'Day',
                    name: "goals[" + goalLoop.index0 + "][anotherDate][day]",
                    classes: 'govuk-input--width-2',
                    value: formValues.goals[(goalLoop.index0)]['anotherDate']['day']
                  },
                  {
                    id: 'goals-' + goalLoop.index0 + '-anotherDate-month',
                    label: 'Month',
                    name: "goals[" + goalLoop.index0 + "][anotherDate][month]",
                    classes: 'govuk-input--width-2',
                    value: formValues.goals[(goalLoop.index0)]['anotherDate']['month']
                  },
                  {
                    id: 'goals-' + goalLoop.index0 + '-anotherDate-year',
                    label: 'Year',
                    name: "goals[" + goalLoop.index0 + "][anotherDate][year]",
                    classes: 'govuk-input--width-4',
                    value: formValues.goals[(goalLoop.index0)]['anotherDate']['year']
                  }
                ],
                errorMessage: validationErrors | findError("goals-" + goalLoop.index0 + "-anotherDate")
              }) }}
            {% endset -%}

            {{ govukRadios({
              name: "goals[" + goalLoop.index0 + "][targetCompletionDateOption]",
              idPrefix: "goals-" + goalLoop.index0 + "-targetCompletionDateOption",
              value: formValues.goals[(goalLoop.index0)].targetCompletionDateOption,
              fieldset: {
                legend: {
                  text: "When are they aiming to achieve this goal by?",
                  classes: "govuk-fieldset__legend--s"
                }
              },
              items: [
                {
                  "value": goalCompleteDateOptions.THREE_MONTHS,
                  "text": "in 3 months (by " + now | addMonths(3) | formatDate('d MMMM yyyy') + ")"
                }, {
                  "value": goalCompleteDateOptions.SIX_MONTHS,
                  "text": "in 6 months (by " + now | addMonths(6) | formatDate('d MMMM yyyy') + ")"
                }, {
                  "value": goalCompleteDateOptions.TWELVE_MONTHS,
                  "text": "in 12 months (by " + now | addMonths(12) | formatDate('d MMMM yyyy') + ")"
                }, {
                  "value": goalCompleteDateOptions.ANOTHER_DATE,
                  "text": "set another date",
                  "conditional": {
                    "html": anotherDateHtml
                  }
                }
              ],
              errorMessage: validationErrors | findError("goals-" + goalLoop.index0 + "-targetCompletionDateOption")
            }) }}

            <h3 class="govuk-heading-s">Add steps to help them achieve this goal</h3>

            {% for steps in formValues.goals[goalLoop.index0].steps or range(1) %}
              {% set stepLoop = loop %}

              {% call govukFieldset({
                classes: 'moj-add-another__item',
                legend: {
                  text: 'Description and actions for step ' + stepLoop.index + ' of goal ' + goalLoop.index,
                  classes: 'govuk-visually-hidden',
                  isPageHeading: false
                }
              }) %}

                {{ govukCharacterCount({
                  name: "goals[" + goalLoop.index0 + "][steps][" + stepLoop.index0 + "][title]",
                  id: "goals-" + goalLoop.index0 + "-steps-" + stepLoop.index0 + "-title",
                  value: formValues.goals[(goalLoop.index0)].steps[(stepLoop.index0)].title,
                  maxlength: 512,
                  rows: 2,
                  label: {
                    text: 'Step ' + stepLoop.index,
                    classes: "govuk-label--s",
                    isPageHeading: false
                  },
                  hint: {
                    text: "Describe this step"
                  },
                  charactersOverLimitText: {
                    one: 'Step must be 512 characters or less',
                    other: 'Step must be 512 characters or less'
                  },
                  errorMessage: validationErrors | findError('goals-' + goalLoop.index0 + '-steps-' + stepLoop.index0 + '-title')
                }) }}

                {% if stepLoop.length > 1 %}
                  {{ govukButton({
                    name: "action",
                    value: "remove-step|" + goalLoop.index0 + "|" + stepLoop.index0,
                    text: "Remove step",
                    classes: "govuk-button--secondary moj-add-another__remove-button",
                    attributes: {
                      'data-qa': 'remove-step-button',
                      formaction: 'create/REMOVE_STEP?goalNumber=' + goalLoop.index0 + '&stepNumber=' + stepLoop.index0
                    }
                  }) }}
                {% endif %}
              {% endcall %}
            {% endfor %}

            <div class="govuk-form-group govuk-!-margin-bottom-2">
              {{ govukButton({
                id: "add-another-step-to-goal-" + goalLoop.index0 + "-button",
                name: "action",
                value: "add-another-step|" + goalLoop.index0,
                text: "Add another step to this goal",
                classes: "govuk-button--secondary",
                attributes: {
                  formaction: 'create/ADD_STEP?goalNumber=' + goalLoop.index0
                }
              }) }}
            </div>

            <div class="govuk-form-group">
              <div class="govuk-form-group">
                <h1 class="govuk-label-wrapper">
                  <label class="govuk-label govuk-label--s" for="goals[{{ goalLoop.index0 }}][note]">
                    Add a note to this goal (optional)
                  </label>
                </h1>
                <div class="govuk-warning-text govuk-!-margin-top-4">
                  <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
                  <strong class="govuk-warning-text__text">
                    <span class="govuk-visually-hidden">Warning</span>
                    This note will be seen by the prisoner and other prison staff.
                  </strong>
                </div>
                {{ errors | findError("goals[" + goalLoop.index0 + "].note") }}
                <textarea 
                  class="govuk-textarea"
                  id="goals[{{ goalLoop.index0 }}][note]"
                  name="goals[{{ goalLoop.index0 }}][note]"
                  rows="5"
                  aria-describedby="warning-text">{{ formValues.goals[goalLoop.index0].note }}</textarea>
              </div>
            </div>

          </div>
        </div>
        {% endfor %}

        <div class="govuk-form-group">
          {{ govukButton({
            id: "add-another-goal-button",
            name: "action",
            value: "add-another-goal",
            text: "Add another goal",
            classes: "govuk-button--secondary",
            attributes: {
              formaction: 'create/ADD_GOAL'
            }
          }) }}
        </div>

        {{ govukButton({
          id: "submit-button",
          name: "action",
          value: "submit-form",
          text: "Save to learning and work progress plan"
        }) }}

      </form>

    </div>
  </div>

{% endblock %}
